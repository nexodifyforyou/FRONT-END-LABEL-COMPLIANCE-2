name: Fix ReportPage React crash (#31)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Patch ReportPage to safely render objects
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const candidates = [
            'frontend/src/pages/ReportPage.jsx',
            'frontend/src/pages/ReportPage.tsx',
            'frontend/src/pages/ReportPage.js',
            'frontend/src/pages/ReportPage.ts',
          ];

          const fp = candidates
            .map(p => path.join(process.cwd(), p))
            .find(p => fs.existsSync(p));

          if (!fp) {
            console.error('ERROR: ReportPage file not found. Checked:', candidates.join(', '));
            process.exit(1);
          }

          let s = fs.readFileSync(fp, 'utf8');
          const before = s;

          // Fix #31: React cannot render objects like {label,value} directly.
          // Replace any JSX "{value}" used in the "label/value row" UI with a safe formatter.
          s = s.replace(
            /\{value\}<\/span>/g,
            `{(value && typeof value === 'object'
              ? (value.label ?? value.value ?? JSON.stringify(value))
              : (Array.isArray(value) ? value.join(', ') : String(value ?? '-'))
            )}</span>`
          );

          // Also reduce risk for languages row if it uses join() on a non-array.
          s = s.replace(
            /run\.languages_provided\?\.\s*join\([^\)]*\)/g,
            `(Array.isArray(run.languages_provided) ? run.languages_provided.join(', ') : (run.languages_provided?.label ?? run.languages_provided?.value ?? run.languages_provided ?? 'English'))`
          );

          if (s === before) {
            console.log('No changes made (pattern not found). File:', fp);
          } else {
            fs.writeFileSync(fp, s, 'utf8');
            console.log('Patched:', fp);
          }
          NODE

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add frontend/src/pages/ReportPage.* || true
          git commit -m "Fix ReportPage crash: render-safe values (React #31)" || echo "Nothing to commit"
          git push
