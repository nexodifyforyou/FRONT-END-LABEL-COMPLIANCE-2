name: Fix React crash (#31) on ReportPage

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Patch ReportPage.jsx (render-safe values)
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const fp = path.join(process.cwd(), 'frontend', 'src', 'pages', 'ReportPage.jsx');
          if (!fs.existsSync(fp)) {
            console.error('ERROR: File not found:', fp);
            process.exit(1);
          }

          let s = fs.readFileSync(fp, 'utf8');
          let changed = false;

          // 1) Insert fmt helper (prevents React crash when values are objects)
          if (!s.includes('const fmt = (v) =>')) {
            const anchor = 'export default function ReportPage() {';
            const i = s.indexOf(anchor);
            if (i < 0) {
              console.error('ERROR: Anchor not found in ReportPage.jsx');
              process.exit(1);
            }
            const insertAt = i + anchor.length;

            const helper = `

  // Render-safe formatter: prevents React crash when values are objects (e.g., { label, value })
  const fmt = (v) => {
    if (v === null || v === undefined) return 'â€”';
    if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') return String(v);
    if (Array.isArray(v)) return v.map(fmt).join(', ');
    if (typeof v === 'object') return v.label || v.value || JSON.stringify(v);
    return String(v);
  };
`;
            s = s.slice(0, insertAt) + helper + s.slice(insertAt);
            changed = true;
          }

          // 2) Patch the Product Information map block:
          //    - Stop using .join() on languages (not needed)
          //    - Render fmt(value) so objects never crash React
          const re = /\{\[\s*[\s\S]*?\]\.map\(\(\[label,\s*value\]\)\s*=>\s*\([\s\S]*?\)\)\s*\}/m;
          const m = re.exec(s);
          if (!m) {
            console.error('ERROR: Could not find the map block in Product Information section.');
            process.exit(1);
          }

          const block = m[0];
          if (!block.includes("['Country of Sale'") || !block.includes("['Product Name'")) {
            console.error('ERROR: Matched block does not look like Product Information. Aborting.');
            process.exit(1);
          }

          let newBlock = block;

          // Replace languages line if present with join()
          newBlock = newBlock.replace(
            /\['Languages',\s*run\.languages_provided\?\.\s*join\([^\)]*\)\s*\|\|\s*'English'\s*\]/,
            "['Languages', run.languages_provided || 'English']"
          );

          // Replace render {value} with {fmt(value)} (the real fix)
          newBlock = newBlock.replace(
            /\{value\}<\/span>/,
            "{fmt(value)}</span>"
          );

          if (newBlock !== block) {
            s = s.replace(block, newBlock);
            changed = true;
          }

          if (!changed) {
            console.log('No changes needed (already patched).');
            process.exit(0);
          }

          fs.writeFileSync(fp, s, 'utf8');
          console.log('Patched:', fp);
          NODE

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add frontend/src/pages/ReportPage.jsx
          git commit -m "Fix ReportPage crash: render-safe values (React #31)" || echo "Nothing to commit"
          git push
