name: Patch ReportPage render crash

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Patch file with sed (safe object rendering)
        run: |
          FILE="frontend/src/pages/ReportPage.jsx"
          test -f "$FILE" || (echo "Missing $FILE" && exit 1)

          # Replace "{value}</span>" with a safe renderer expression
          sed -i "s/{value}<\\/span>/{(value \\&\\& typeof value === 'object' ? (value.label ?? value.value ?? JSON.stringify(value)) : (Array.isArray(value) ? value.join(', ') : String(value ?? 'â€”')))}<\\/span>/g" "$FILE"

          # Replace languages join if present
          sed -i "s/\\['Languages', run.languages_provided?.join(', ') || 'English'\\],/\\['Languages', run.languages_provided || 'English'\\],/g" "$FILE"

          echo "Patched $FILE"

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add frontend/src/pages/ReportPage.jsx
          git commit -m "Patch ReportPage: prevent React #31 object render crash" || echo "Nothing to commit"
          git push
